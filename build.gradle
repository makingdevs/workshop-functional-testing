import org.apache.tools.ant.taskdefs.condition.Os

plugins {
  id "groovy"
  id 'com.patdouble.cucumber-jvm' version '0.19'
}

ext {
  groovyVersion = '3.0.8'
  gebVersion = '4.1'
  htmlUnitVersion = '2.52.0'
  seleniumVersion = '3.141.59'
  cucumberJvmVersion = '6.11.0'
  chromeDriverVersion = '2.37'
  firefoxDriverVersion = '0.20.0'
}

// apply from: "osSpecificDownloads.gradle"

repositories {
  mavenCentral()
  jcenter()
}

sourceCompatibility = 11
targetCompatibility = 11

dependencies {
  compile "org.codehaus.groovy:groovy-all:$groovyVersion"
  testCompile "io.cucumber:cucumber-core:$cucumberJvmVersion"
  testCompile "io.cucumber:cucumber-groovy:$cucumberJvmVersion"
  testCompile "io.cucumber:cucumber-junit:$cucumberJvmVersion"
  testCompile "org.gebish:geb-core:$gebVersion"
  testCompile "org.seleniumhq.selenium:selenium-htmlunit-driver:$htmlUnitVersion"
  testCompile "org.seleniumhq.selenium:selenium-firefox-driver:$seleniumVersion"
  testCompile "org.seleniumhq.selenium:selenium-chrome-driver:$seleniumVersion"
  testCompile "org.seleniumhq.selenium:selenium-support:$seleniumVersion"
}

cucumber {
  def tagsToRun = System.getProperty("cucumber.tags")
  formats = ['pretty','json:build/cucumber.json','junit:build/cucumber.xml','html:build/reports/cucumber']
  tags = tagsToRun ? [tagsToRun] : []
}

tasks.cucumber {
  dependsOn unzipChromeDriver, unzipPhantomJs

  def chromeDriverFilename = Os.isFamily(Os.FAMILY_WINDOWS) ? "chromedriver.exe" : "chromedriver"
  def phantomJsFilename = Os.isFamily(Os.FAMILY_WINDOWS) ? "phantomjs.exe" : "bin/phantomjs"
  def firefoxFilename = Os.isFamily(Os.FAMILY_WINDOWS) ? "geckodriver.exe" : "geckodriver"

  def properties = [
    "webdriver.chrome.driver": new File(unzipChromeDriver.outputs.files.singleFile, chromeDriverFilename).absolutePath,
    "phantomjs.binary.path": new File(unzipPhantomJs.outputs.files.singleFile, phantomJsFilename).absolutePath,
    "webdriver.gecko.driver": new File(unzipFirefox.outputs.files.singleFile, firefoxFilename).absolutePath,
    //"geb.cucumber.step.packages": "pages",
    "geb.env": System.getProperty("geb.env")
  ]

  if(System.getProperty("geb.saucelabs.file"))
    properties."geb.saucelabs.browser" = new File(System.getProperty("geb.saucelabs.file"))?.text

  jvmOptions.systemProperties(properties)
}
